<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Snake Monxia</title>

    <!-- Farcaster Frame -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://yourdomain.com/og.png" />
    <meta property="fc:frame:button:1" content="Play Snake" />
    <meta property="fc:frame:button:1:action" content="link" />
    <meta property="fc:frame:button:1:target" content="https://snake-monxia.vercel.app" />

    <style>
        :root {
            --bg: #0b0211;
            --card: #12051a;
            --accent: #9b59ff;
            --muted: #9e88b8;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: #eee;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
        }

        .wrap {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 12px;
        }

        .card {
            background: var(--card);
            border-radius: : 14px;
            padding: 16px;
            border: 1px solid rgba(155, 89, 255, 0.1);
        }

        .left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .right {
            display: none;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
        }

        .small {
            font-size: 11px;
            color: var(--muted);
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(90deg, var(--accent), #6f4bff);
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--muted);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hud {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .hud .item {
            background: var(--glass);
            padding: 6px 10px;
            border-radius: 8px;
            text-align: center;
            min-width: 60px;
        }

        .item .label {
            font-size: 10px;
            color: var(--muted);
        }

        .item .value {
            font-weight: 700;
            font-size: 14px;
        }

        #gameHolder {
            position: relative;
            flex: 1;
        }

        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            border-radius: 10px;
            background: #05020b;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        . touch-controls {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 120px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 4px;
            pointer-events: none;
        }

        .touch-zone {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        #touchUp {
            grid-column: 2;
            grid-row: 1;
        }

        #touchLeft {
            grid-column: 1;
            grid-row: 2;
        }

        #touchDown {
            grid-column: 2;
            grid-row: 2;
        }

        #touchRight {
            grid-column: 3;
            grid-row: 2;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            backdrop-filter: blur(8px);
        }

        .modal {
            background: var(--card);
            padding: 20px;
            border-radius: 14px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(155, 89, 255, 0.1);
        }

        .processing {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            display: none;
            z-index: 9999;
        }

        .processing .bar {
            height: 100%;
            background: linear-gradient(90deg, #2b0a3f, var(--accent), #4b2bff);
            animation: shimmer 1.2s infinite;
        }

        @keyframes shimmer {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 200% 0;
            }
        }

        #toastContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #toastContainer div {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            animation: slide 0.4s ease;
        }

        @keyframes slide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        @media (min-width: 768px) {
            body {
                padding: 28px;
            }

            .wrap {
                flex-direction: row;
            }

            .left {
                flex: 0 0 480px;
            }

            .right {
                display: block;
                flex: 1;
            }

            .touch-controls {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="processing" id="processing">
        <div class="bar"></div>
    </div>

    <div class="wrap">
        <div class="card left">
            <header>
                <h1>Snake Monxia</h1>
                <div class="small">Play-to-Mint on Monad</div>
            </header>

            <div class="top-row">
                <div>
                    <div class="small">Wallet</div>
                    <div style="display:flex; gap:6px; align-items:center; margin-top:4px; flex-wrap:wrap;">
                        <button class="btn" id="connectBtn">Connect</button>
                        <button class="btn ghost" id="disconnectBtn" style="display:none">×</button>
                        <div class="muted" id="addr">Not connected</div>
                    </div>
                </div>
                <div class="muted small" id="network">—</div>
            </div>

            <div id="menu" class="menu">
                <button class="btn" id="newGame">New Game</button>
                <button class="btn ghost" id="buy">Buy Snakes</button>
                <button class="btn ghost" id="deposit">Deposit</button>
                <button class="btn ghost" id="leaderboardBtn">Leaderboard</button>
                <button class="btn ghost" id="help">Help</button>
            </div>

            <div id="gameHolder" style="display:none">
                <canvas id="canvas"></canvas>
                <div class="touch-controls" id="touch" style="display:none">
                    <div class="touch-zone" id="touchUp"></div>
                    <div class="touch-zone" id="touchLeft"></div>
                    <div class="touch-zone" id="touchDown"></div>
                    <div class="touch-zone" id="touchRight"></div>
                </div>
                <div class="hud" id="hud" style="display:none">
                    <div class="item">
                        <div class="label">Score</div>
                        <div class="value" id="score">0</div>
                    </div>
                    <div class="item">
                        <div class="label">Lives</div>
                        <div class="value" id="lives">Heart</div>
                    </div>
                    <div class="item">
                        <div class="label">Type</div>
                        <div class="value" id="type">classic</div>
                    </div>
                    <button class="btn ghost" id="pause" style="margin-left:auto">Pause</button>
                </div>
            </div>

            <div class="modal-backdrop" id="modal">
                <div class="modal">
                    <h3 id="modalTitle">Game Over</h3>
                    <div id="modalBody" class="muted">Score: <strong id="finalScore">0</strong></div>
                    <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
                        <button class="btn" id="action1">Play Again</button>
                        <button class="btn ghost" id="action2">Menu</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card right screens" id="screens">
            <div id="screenMenu" class="screen active">
                <h3>Main Menu</h3>
                <div class="muted">Choose an action.</div>
            </div>

            <div id="screenBuy" class="screen">
                <h3>Buy Snakes</h3>
                <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                    <button class="btn" id="mintClassicBtn">Mint Classic — 0.01 MON</button>
                    <button class="btn" id="mintFastBtn">Mint Fast — 1 MON</button>
                    <button class="btn" id="mintHeartyBtn">Mint Hearty — 1 MON</button>
                    <button class="btn" id="mintLongBtn">Mint Long — 1 MON</button>
                </div>
                <div style="margin-top:12px">
                    <div class="small">Select minted snake:</div>
                    <select id="selectOwnedSnakes"
                        style="margin-top:8px; width:100%; padding:8px; border-radius:8px; background:transparent; color:#fff;"></select>
                    <div style="margin-top:10px">
                        <button class="btn ghost" id="buyBack">Back</button>
                    </div>
                </div>
            </div>

            <div id="screenDeposit" class="screen">
                <h3>Deposit to Game</h3>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input id="depositAmount" placeholder="0.05"
                        style="padding:8px; border-radius:8px; background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.03)" />
                    <button class="btn" id="depositBtn">Deposit</button>
                </div>
                <div style="margin-top:12px">
                    <button class="btn ghost" id="depositBack">Back</button>
                </div>
            </div>

            <div id="screenHelp" class="screen">
                <h3>Help</h3>
                <div class="muted" style="margin-top:10px">
                    Use arrow keys or tap screen zones on mobile. Eat the white dot to score.
                </div>
                <div style="margin-top:12px">
                    <button class="btn ghost" id="helpBack">Back</button>
                </div>
            </div>

            <div id="screenLeaderboard" class="screen">
                <h3>Leaderboard</h3>
                <table id="leaderboardTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Wallet</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="btn ghost" style="margin-top:12px" id="leaderboardBack">Back</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <!-- Supabase -->
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

    <!-- Web3Modal + Wagmi (via CDN - no importmap) -->
    <script type="module">
        // Load Web3Modal
        import { createWeb3Modal } from 'https://unpkg.com/@web3modal/wagmi@5.1.12/dist/esm/index.js';
        import { walletConnect, metaMask, coinbaseWallet } from 'https://unpkg.com/@wagmi/connectors@5.1.12/dist/esm/index.js';
        import { createConfig, http } from 'https://unpkg.com/wagmi@2.12.16/dist/esm/index.js';
        import { createPublicClient, createWalletClient, custom, getContract, parseEther } from 'https://unpkg.com/viem@2.21.1/dist/esm/index.js';

        const monadTestnet = {
            id: 10143,
            name: 'Monad Testnet',
            nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
            rpcUrls: { default: { http: ['https://testnet-rpc.monad.xyz'] } },
            blockExplorers: { default: { url: 'https://testnet.monadexplorer.com' } },
            testnet: true,
        };

        const projectId = 'd0a0230a461b71859ecd0ffe6433a89d';

        const config = createConfig({
            chains: [monadTestnet],
            transports: { [monadTestnet.id]: http() },
            connectors: [
                walletConnect({ projectId, showQrModal: false }),
                metaMask(),
                coinbaseWallet({ appName: 'Snake Monxia' }),
            ],
        });

        const modal = createWeb3Modal({
            wagmiConfig: config,
            projectId,
            themeMode: 'dark',
            themeVariables: { '--w3m-accent': '#9b59ff' },
            defaultChain: monadTestnet,
        });

        const CONTRACT_ADDRESS = "0x238efb5E1DB138E92ae39aAE9f9B6FdcfFd76437";
        const FOOD_FEE = BigInt(4e14);

        const CONTRACT_ABI = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "coinAddress",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ERC721IncorrectOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721InsufficientApproval",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "approver",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidApprover",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidOperator",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "receiver",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidReceiver",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidSender",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721NonexistentToken",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ReentrancyGuardReentrantCall",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "approved",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "ApprovalForAll",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "count",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "totalPaid",
                        "type": "uint256"
                    }
                ],
                "name": "BatchConsumed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "_fromTokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "_toTokenId",
                        "type": "uint256"
                    }
                ],
                "name": "BatchMetadataUpdate",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "DepositToGame",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "FoodPaid",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "_tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "MetadataUpdate",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "mode",
                        "type": "uint8"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "score",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "coinsEarned",
                        "type": "uint256"
                    }
                ],
                "name": "ScoreSubmitted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "skin",
                        "type": "uint8"
                    }
                ],
                "name": "SkinApplied",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "components": [
                            {
                                "internalType": "uint8",
                                "name": "speed",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "hearts",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "length",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "skin",
                                "type": "uint8"
                            },
                            {
                                "internalType": "bool",
                                "name": "isClassic",
                                "type": "bool"
                            }
                        ],
                        "indexed": false,
                        "internalType": "struct SnakeMonxiaGame.SnakeAttributes",
                        "name": "attrs",
                        "type": "tuple"
                    }
                ],
                "name": "SnakeMinted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "attr",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "newValue",
                        "type": "uint8"
                    }
                ],
                "name": "SnakeUpgraded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "BASE_UPGRADE_COST",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "CLASSIC_MINT_PRICE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "FOOD_FEE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "SKIN_PRICE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "SPECIAL_MINT_PRICE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint8",
                        "name": "skinId",
                        "type": "uint8"
                    }
                ],
                "name": "applySkin",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "current",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "target",
                        "type": "uint8"
                    }
                ],
                "name": "calculateUpgradeCost",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "pure",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "coins",
                "outputs": [
                    {
                        "internalType": "contract MonxiaCoin",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "count",
                        "type": "uint256"
                    }
                ],
                "name": "consumeBatch",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "consumeFromBalance",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "depositToGame",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "gameBalances",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "getApproved",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "isApprovedForAll",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "isClassicSnake",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintClassic",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintFastSnake",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintHeartySnake",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintLongSnake",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ownerOf",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "payForFood",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    },
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "personalBests",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bytes",
                        "name": "data",
                        "type": "bytes"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "setApprovalForAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newTreasury",
                        "type": "address"
                    }
                ],
                "name": "setTreasury",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "snakeAttributes",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "speed",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "hearts",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "length",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "skin",
                        "type": "uint8"
                    },
                    {
                        "internalType": "bool",
                        "name": "isClassic",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes4",
                        "name": "interfaceId",
                        "type": "bytes4"
                    }
                ],
                "name": "supportsInterface",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "tokenURI",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "topPlayers",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "topScores",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "treasury",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const SUPABASE_URL = "https://wusexxzubjfrxifelgob.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1c2V4eHp1YmpmcnhpZmVsZ29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDQzNTQsImV4cCI6MjA3NTQ4MDM1NH0.S_LICfku-L_Y6GPOZGMT4X_swMZjJD-ZMumeq3HUR74";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let publicClient, walletClient, contract, userAddress;

        const processing = document.getElementById("processing");
        const start = () => processing.style.display = "block";
        const stop = () => processing.style.display = "none";

        function toast(msg, type = 'info') {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.innerText = msg;
            t.style.background = type === 'success' ? '#6d28d9' : type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : '#6366f1';
            t.style.background = `linear-gradient(90deg, ${t.style.background}, #8b5cf6)`;
            c.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(20px)'; setTimeout(() => t.remove(), 400); }, 3000);
        }

        modal.subscribeProvider(async (p) => {
            if (!p) {
                userAddress = null; contract = null;
                document.getElementById('addr').innerText = 'Not connected';
                document.getElementById('connectBtn').style.display = 'inline-block';
                document.getElementById('disconnectBtn').style.display = 'none';
                document.getElementById('network').innerText = '—';
                return;
            }
            start();
            try {
                const accounts = await p.request({ method: 'eth_accounts' });
                userAddress = accounts[0];
                document.getElementById('addr').innerText = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('network').innerText = 'Monad';

                publicClient = createPublicClient({ chain: monadTestnet, transport: custom(p) });
                walletClient = createWalletClient({ chain: monadTestnet, transport: custom(p), account: userAddress });
                contract = getContract({ address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, client: { public: publicClient, wallet: walletClient } });

                const chainId = await p.request({ method: 'eth_chainId' });
                if (parseInt(chainId, 16) !== monadTestnet.id) {
                    try { await p.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: `0x${monadTestnet.id.toString(16)}` }] }); }
                    catch { await p.request({ method: 'wallet_addEthereumChain', params: [monadTestnet] }); }
                }
                refreshSnakes();
            } catch (e) { toast('Connect failed', 'error'); } finally { stop(); }
        });

        document.getElementById('connectBtn').onclick = () => { start(); modal.open(); };
        document.getElementById('disconnectBtn').onclick = () => modal.disconnect();

        async function tx(fn, msg) {
            if (!contract) return toast('Connect wallet', 'warning');
            start();
            try {
                const { hash } = await fn();
                await publicClient.waitForTransactionReceipt({ hash });
                toast(msg || 'Done!', 'success');
                setTimeout(refreshSnakes, 1000);
            } catch (e) { toast(e.shortMessage || 'Failed', 'error'); } finally { stop(); }
        }

        document.getElementById('mintClassicBtn').onclick = () => tx(() => contract.write.mintClassic([userAddress], { value: parseEther('0.01') }), 'Minted!');
        document.getElementById('mintFastBtn').onclick = () => tx(() => contract.write.mintFastSnake([userAddress], { value: parseEther('1') }));
        document.getElementById('mintHeartyBtn').onclick = () => tx(() => contract.write.mintHeartySnake([userAddress], { value: parseEther('1') }));
        document.getElementById('mintLongBtn').onclick = () => tx(() => contract.write.mintLongSnake([userAddress], { value: parseEther('1') }));

        async function refreshSnakes() {
            const sel = document.getElementById('selectOwnedSnakes');
            sel.innerHTML = '<option>Loading...</option>';
            if (!contract) return;
            try {
                const bal = Number(await contract.read.balanceOf([userAddress]));
                sel.innerHTML = bal ? '' : '<option>No snakes</option>';
                for (let i = 1; i <= 1000 && sel.children.length < bal; i++) {
                    try {
                        const owner = await contract.read.ownerOf([BigInt(i)]);
                        if (owner.toLowerCase() === userAddress.toLowerCase()) sel.appendChild(new Option(`#${i}`, i));
                    } catch { }
                }
            } catch { sel.innerHTML = '<option>Error</option>'; }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id)?.classList.add('active');
        }

        document.getElementById('buy').onclick = () => showScreen('screenBuy');
        document.getElementById('deposit').onclick = () => showScreen('screenDeposit');
        document.getElementById('help').onclick = () => showScreen('screenHelp');
        document.getElementById('buyBack').onclick = () => showScreen('screenMenu');
        document.getElementById('depositBack').onclick = () => showScreen('screenMenu');
        document.getElementById('helpBack').onclick = () => showScreen('screenMenu');

        document.getElementById('leaderboardBtn').onclick = async () => {
            showScreen('screenLeaderboard');
            const tbody = document.querySelector('#leaderboardTable tbody');
            tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            try {
                const { data } = await supabase.from('leaderboard').select('wallet, score').order('score', { ascending: false }).limit(10);
                tbody.innerHTML = '';
                data.forEach((row, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${i + 1}</td><td>${row.wallet.slice(0, 6)}...${row.wallet.slice(-4)}</td><td>${row.score}</td>`;
                    tbody.appendChild(tr);
                });
            } catch { tbody.innerHTML = '<tr><td colspan="3">Failed to load</td></tr>'; }
        };
        document.getElementById('leaderboardBack').onclick = () => showScreen('screenMenu');

        // Game
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let size, grid, state = { snake: [], dir: {}, food: {}, score: 0, lives: 1, type: 'classic', speed: 150, running: false };

        function resize() {
            const rect = document.getElementById('gameHolder').getBoundingClientRect();
            size = Math.min(rect.width, rect.height * 0.8);
            canvas.width = canvas.height = size;
            grid = size / 20;
            if (state.running) draw();
        }
        window.addEventListener('resize', resize);

        function startGame() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameHolder').style.display = 'block';
            document.getElementById('hud').style.display = 'flex';
            hideModal();
            resize();
            reset();
            if (/Mobi/.test(navigator.userAgent)) document.getElementById('touch').style.display = 'grid';
        }

        function reset() {
            state = {
                snake: [{ x: 10, y: 10 }], dir: { x: 1, y: 0 },
                food: rand(), score: 0, lives: 1, type: 'classic', speed: 150, running: true
            };
            updateHUD(); draw(); tick();
        }

        function rand() { return { x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20) }; }

        function draw() {
            ctx.fillStyle = '#05020b'; ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc((state.food.x + 0.5) * grid, (state.food.y + 0.5) * grid, grid / 3, 0, Math.PI * 2); ctx.fill();
            state.snake.forEach((s, i) => {
                const cx = (s.x + 0.5) * grid, cy = (s.y + 0.5) * grid;
                if (i === 0) {
                    ctx.fillStyle = state.type === 'classic' ? '#b388ff' : '#00ffaa';
                    ctx.beginPath(); ctx.arc(cx, cy, grid / 2.1, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.beginPath(); ctx.arc(cx - grid / 5, cy - grid / 6, grid / 10, 0, Math.PI * 2);
                    ctx.arc(cx + grid / 5, cy - grid / 6, grid / 10, 0, Math.PI * 2); ctx.fill();
                } else {
                    const t = i / state.snake.length;
                    ctx.fillStyle = `rgba(179,136,255,${0.6 * (1 - t) + 0.2})`;
                    ctx.beginPath(); ctx.arc(cx, cy, (grid / 2.5) * (1 - t * 0.6), 0, Math.PI * 2); ctx.fill();
                }
            });
        }

        function tick() {
            if (!state.running) return;
            let head = { x: state.snake[0].x + state.dir.x, y: state.snake[0].y + state.dir.y };
            head.x = (head.x + 20) % 20; head.y = (head.y + 20) % 20;

            if (state.snake.slice(1).some(s => s.x === head.x && s.y === head.y)) {
                if (state.lives > 1) { state.lives--; state.snake = state.snake.slice(0, Math.max(1, state.snake.length >> 1)); }
                else return gameOver();
            } else state.snake.unshift(head);

            if (head.x === state.food.x && head.y === state.food.y) {
                state.score += 10;
                state.food = rand();
                if (contract) tx(() => contract.write.payForFood({ value: FOOD_FEE }));
            } else state.snake.pop();

            updateHUD(); draw();
            setTimeout(tick, state.speed);
        }

        function updateHUD() {
            document.getElementById('score').innerText = state.score;
            document.getElementById('lives').innerText = 'Heart'.repeat(state.lives);
            document.getElementById('type').innerText = state.type;
        }

        function gameOver() {
            state.running = false;
            toast(`Game Over! Score: ${state.score}`, 'error');
            if (contract) tx(() => contract.write.submitScore([0, BigInt(state.score)]));
            showModal('Game Over', `Score: <strong>${state.score}</strong>`, 'Play Again', 'Menu', reset, () => {
                document.getElementById('menu').style.display = 'flex';
                document.getElementById('gameHolder').style.display = 'none';
                document.getElementById('hud').style.display = 'none';
                hideModal();
            });
        }

        function showModal(t, b, a1, a2, f1, f2) {
            document.getElementById('modalTitle').innerText = t;
            document.getElementById('modalBody').innerHTML = b;
            const btn1 = document.getElementById('action1'); btn1.innerText = a1; btn1.onclick = f1;
            const btn2 = document.getElementById('action2'); btn2.innerText = a2; btn2.onclick = f2;
            document.getElementById('modal').style.display = 'flex';
        }
        function hideModal() { document.getElementById('modal').style.display = 'none'; }

        ['touchUp', 'touchDown', 'touchLeft', 'touchRight'].forEach(id => {
            document.getElementById(id).addEventListener('touchstart', e => { e.preventDefault(); handleDir(id); });
        });
        function handleDir(id) {
            if (!state.running) return;
            const d = state.dir;
            if (id === 'touchUp' && d.y !== 1) state.dir = { x: 0, y: -1 };
            if (id === 'touchDown' && d.y !== -1) state.dir = { x: 0, y: 1 };
            if (id === 'touchLeft' && d.x !== 1) state.dir = { x: -1, y: 0 };
            if (id === 'touchRight' && d.x !== -1) state.dir = { x: 1, y: 0 };
        }

        document.getElementById('pause').onclick = () => {
            state.running = !state.running;
            document.getElementById('pause').innerText = state.running ? 'Pause' : 'Resume';
        };

        document.getElementById('newGame').onclick = async () => {
            if (!contract) return toast('Connect wallet', 'warning');
            start();
            try {
                const bal = await contract.read.balanceOf([userAddress]);
                if (bal === 0n) { toast('Mint a snake first!', 'warning'); showScreen('screenBuy'); stop(); return; }
                startGame();
            } catch { toast('Error', 'error'); } finally { stop(); }
        };

        resize();
    </script>
</body>

</html>
