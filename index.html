<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Snake Monxia</title>

    <!-- Farcaster Frame -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://yourdomain.com/og.png" />
    <meta property="fc:frame:button:1" content="Play Snake" />
    <meta property="fc:frame:button:1:action" content="link" />
    <meta property="fc:frame:button:1:target" content="https://snake-monxia.vercel.app" />

    <style>
        :root {
            --bg: #0b0211;
            --card: #12051a;
            --accent: #9b59ff;
            --muted: #9e88b8;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: #eee;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
        }

        .wrap {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 12px;
        }

        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid rgba(155, 89, 255, 0.1);
        }

        .left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .right {
            display: none;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
        }

        .small {
            font-size: 11px;
            color: var(--muted);
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(90deg, var(--accent), #6f4bff);
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--muted);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hud {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .hud .item {
            background: var(--glass);
            padding: 6px 10px;
            border-radius: 8px;
            text-align: center;
            min-width: 60px;
        }

        .item .label {
            font-size: 10px;
            color: var(--muted);
        }

        .item .value {
            font-weight: 700;
            font-size: 14px;
        }

        #gameHolder {
            position: relative;
            flex: 1;
        }

        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            border-radius: 10px;
            background: #05020b;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .touch-controls {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 120px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 4px;
            pointer-events: none;
            z-index: 10;
        }

        .touch-zone {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        #touchUp {
            grid-column: 2;
            grid-row: 1;
        }

        #touchLeft {
            grid-column: 1;
            grid-row: 2;
        }

        #touchDown {
            grid-column: 2;
            grid-row: 2;
        }

        #touchRight {
            grid-column: 3;
            grid-row: 2;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            backdrop-filter: blur(8px);
        }

        .modal {
            background: var(--card);
            padding: 20px;
            border-radius: 14px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(155, 89, 255, 0.1);
        }

        .processing {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            display: none;
            z-index: 1000;
        }

        .processing .bar {
            height: 100%;
            background: linear-gradient(90deg, #2b0a3f, var(--accent), #4b2bff);
            animation: shimmer 1.2s infinite;
        }

        @keyframes shimmer {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 200% 0;
            }
        }

        #toastContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #toastContainer div {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            animation: slide 0.4s ease;
        }

        @keyframes slide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        @media (min-width: 768px) {
            body {
                padding: 28px;
            }

            .wrap {
                flex-direction: row;
            }

            .left {
                flex: 0 0 480px;
            }

            .right {
                display: block;
                flex: 1;
            }

            .touch-controls {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="processing" id="processing">
        <div class="bar"></div>
    </div>

    <div class="wrap">
        <div class="card left">
            <header>
                <h1>üêç Snake Monxia</h1>
                <div class="small">Retro + Web3 ‚Äî Play, mint snakes, pay-per-food or prepay</div>
            </header>

            <div class="top-row">
                <div>
                    <div class="small">Wallet</div>
                    <div style="display:flex; gap:6px; align-items:center; margin-top:4px; flex-wrap:wrap;">
                        <button class="btn" id="connectBtn">Connect Wallet</button>
                        <button class="btn ghost" id="disconnectBtn" style="display:none">Disconnect</button>
                        <div class="muted" id="addr">Not connected</div>
                    </div>
                </div>
                <div class="muted small" id="network">‚Äî</div>
            </div>

            <div id="menu" class="menu">
                <button class="btn" id="newGame">New Game</button>
                <button class="btn ghost" id="buy">Buy Snakes</button>
                <button class="btn ghost" id="deposit">Deposit</button>
                <button class="btn ghost" id="leaderboardBtn">Leaderboard</button>
                <button class="btn ghost" id="help">Help</button>
            </div>

            <div id="gameHolder" style="display:none">
                <canvas id="canvas"></canvas>
                <div class="touch-controls" id="touch" style="display:none">
                    <div class="touch-zone" id="touchUp"></div>
                    <div class="touch-zone" id="touchLeft"></div>
                    <div class="touch-zone" id="touchDown"></div>
                    <div class="touch-zone" id="touchRight"></div>
                </div>
                <div class="hud" id="hud" style="display:none">
                    <div class="item">
                        <div class="label">Score</div>
                        <div class="value" id="score">0</div>
                    </div>
                    <div class="item">
                        <div class="label">Hearts</div>
                        <div class="value" id="lives">üíú</div>
                    </div>
                    <div class="item">
                        <div class="label">Type</div>
                        <div class="value" id="type">classic</div>
                    </div>
                    <button class="btn ghost" id="pause" style="margin-left:auto">Pause</button>
                </div>
            </div>

            <div class="modal-backdrop" id="modal">
                <div class="modal">
                    <h3 id="modalTitle">Game Over</h3>
                    <div id="modalBody" class="muted">Score: <strong id="finalScore">0</strong></div>
                    <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
                        <button class="btn" id="action1">Play Again</button>
                        <button class="btn ghost" id="action2">Back to Menu</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card right screens" id="screens">
            <div id="screenMenu" class="screen active">
                <h3>Main Menu</h3>
                <div class="muted">Choose an action to continue.</div>
            </div>
            <div id="screenBuy" class="screen">
                <h3>Buy Snakes</h3>
                <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                    <button class="btn" id="mintClassicBtn">Mint Classic ‚Äî 0.01 MON</button>
                    <button class="btn" id="mintFastBtn">Mint Fast ‚Äî 1 MON</button>
                    <button class="btn" id="mintHeartyBtn">Mint Hearty ‚Äî 1 MON</button>
                    <button class="btn" id="mintLongBtn">Mint Long ‚Äî 1 MON</button>
                </div>
                <div style="margin-top:12px">
                    <div class="small">Select minted snake:</div>
                    <select id="selectOwnedSnakes"
                        style="margin-top:8px; width:100%; padding:8px; border-radius:8px; background:transparent; color:#fff;"></select>
                    <div style="margin-top:10px">
                        <button class="btn ghost" id="buyBack">Back</button>
                    </div>
                </div>
            </div>
            <div id="screenDeposit" class="screen">
                <h3>Deposit to Game</h3>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input id="depositAmount" placeholder="0.05"
                        style="padding:8px; border-radius:8px; background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.03)" />
                    <button class="btn" id="depositBtn">Deposit</button>
                </div>
                <div style="margin-top:12px">
                    <button class="btn ghost" id="depositBack">Back</button>
                </div>
            </div>
            <div id="screenHelp" class="screen">
                <h3>Help</h3>
                <div class="muted" style="margin-top:10px">
                    Use arrow keys or tap screen zones on mobile. Eat the white dot to score.
                </div>
                <div style="margin-top:12px">
                    <button class="btn ghost" id="helpBack">Back</button>
                </div>
            </div>
            <div id="screenLeaderboard" class="screen">
                <h3>Leaderboard</h3>
                <table id="leaderboardTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Wallet</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="btn ghost" style="margin-top:12px" id="leaderboardBack">Back</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script type="module" src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <script type="importmap">
        {
            "imports": {
                "ethers": "https://cdn.jsdelivr.net/npm/ethers@6.13.2/+esm",
                "@web3modal/ethers": "https://cdn.jsdelivr.net/npm/@web3modal/ethers@3.6.1/+esm"
            }
        }
    </script>

    <script type="module">
        import { ethers } from 'ethers';
        import { createWeb3Modal, defaultConfig } from '@web3modal/ethers';

        // --- Constants ---
        const monadTestnet = {
            chainId: 10143,
            name: 'Monad Testnet',
            currency: 'MON',
            explorerUrl: 'https://testnet.monadexplorer.com',
            rpcUrl: 'https://testnet-rpc.monad.xyz'
        };

        const projectId = 'd0a0230a461b71859ecd0ffe6433a89d';
        const CONTRACT_ADDRESS = '0x238efb5E1DB138E92ae39aAE9f9B6FdcfFd76437';
        const FOOD_FEE = ethers.parseEther('0.0004');
        const SUPABASE_URL = 'https://wusexxzubjfrxifelgob.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1c2V4eHp1YmpmcnhpZmVsZ29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDQzNTQsImV4cCI6MjA3NTQ4MDM1NH0.S_LICfku-L_Y6GPOZGMT4X_swMZjJD-ZMumeq3HUR74';

        const CONTRACT_ABI = [
           {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "coinAddress",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ERC721IncorrectOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721InsufficientApproval",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "approver",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidApprover",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidOperator",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "receiver",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidReceiver",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidSender",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721NonexistentToken",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ReentrancyGuardReentrantCall",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "approved",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "ApprovalForAll",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "count",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "totalPaid",
                        "type": "uint256"
                    }
                ],
                "name": "BatchConsumed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "_fromTokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "_toTokenId",
                        "type": "uint256"
                    }
                ],
                "name": "BatchMetadataUpdate",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "DepositToGame",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "FoodPaid",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "_tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "MetadataUpdate",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "mode",
                        "type": "uint8"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "score",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "coinsEarned",
                        "type": "uint256"
                    }
                ],
                "name": "ScoreSubmitted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "skin",
                        "type": "uint8"
                    }
                ],
                "name": "SkinApplied",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "components": [
                            {
                                "internalType": "uint8",
                                "name": "speed",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "hearts",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "length",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "skin",
                                "type": "uint8"
                            },
                            {
                                "internalType": "bool",
                                "name": "isClassic",
                                "type": "bool"
                            }
                        ],
                        "indexed": false,
                        "internalType": "struct SnakeMonxiaGame.SnakeAttributes",
                        "name": "attrs",
                        "type": "tuple"
                    }
                ],
                "name": "SnakeMinted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "attr",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "newValue",
                        "type": "uint8"
                    }
                ],
                "name": "SnakeUpgraded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "BASE_UPGRADE_COST",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "CLASSIC_MINT_PRICE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "FOOD_FEE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "SKIN_PRICE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "SPECIAL_MINT_PRICE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint8",
                        "name": "skinId",
                        "type": "uint8"
                    }
                ],
                "name": "applySkin",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "current",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "target",
                        "type": "uint8"
                    }
                ],
                "name": "calculateUpgradeCost",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "pure",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "coins",
                "outputs": [
                    {
                        "internalType": "contract MonxiaCoin",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "count",
                        "type": "uint256"
                    }
                ],
                "name": "consumeBatch",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "consumeFromBalance",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "depositToGame",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "gameBalances",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "getApproved",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "isApprovedForAll",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "isClassicSnake",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintClassic",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintFastSnake",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintHeartySnake",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "mintLongSnake",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ownerOf",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "payForFood",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    },
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "personalBests",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bytes",
                        "name": "data",
                        "type": "bytes"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "setApprovalForAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newTreasury",
                        "type": "address"
                    }
                ],
                "name": "setTreasury",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "snakeAttributes",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "speed",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "hearts",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "length",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint8",
                        "name": "skin",
                        "type": "uint8"
                    },
                    {
                        "internalType": "bool",
                        "name": "isClassic",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes4",
                        "name": "interfaceId",
                        "type": "bytes4"
                    }
                ],
                "name": "supportsInterface",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "tokenURI",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "topPlayers",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "topScores",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "treasury",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // --- Wallet Setup ---
        const metadata = {
            name: 'Snake Monxia',
            description: 'Play-to-mint snake game on Monad Testnet',
            url: 'https://snake-monxia.vercel.app',
            icons: ['https://yourdomain.com/icon.png']
        };

        const modal = createWeb3Modal({
            ethersConfig: defaultConfig({ metadata }),
            chains: [monadTestnet],
            projectId,
            themeMode: 'dark',
            themeVariables: {
                '--w3m-accent': '#9b59ff',
                '--w3m-background': '#0b0211'
            },
            defaultChain: monadTestnet
        });

        let provider, signer, contract, userAddress;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- UI Utilities ---
        const processing = document.getElementById('processing');
        function startProcessing() { processing.style.display = 'block'; }
        function stopProcessing() { processing.style.display = 'none'; }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.innerText = message;
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '10px';
            toast.style.fontSize = '14px';
            toast.style.color = '#fff';
            toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            toast.style.transition = 'all 0.4s ease';

            switch (type) {
                case 'success': toast.style.background = 'linear-gradient(90deg,#6d28d9,#9333ea)'; break;
                case 'error': toast.style.background = 'linear-gradient(90deg,#ef4444,#dc2626)'; break;
                case 'warning': toast.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)'; break;
                default: toast.style.background = 'linear-gradient(90deg,#6366f1,#8b5cf6)';
            }

            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            });

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // --- Wallet Connection ---
        modal.subscribeProvider(async (newProvider) => {
            if (!newProvider) {
                userAddress = null;
                document.getElementById('addr').innerText = 'Not connected';
                document.getElementById('network').innerText = '‚Äî';
                document.getElementById('connectBtn').style.display = 'inline-block';
                document.getElementById('disconnectBtn').style.display = 'none';
                contract = null;
                showToast('Wallet disconnected', 'warning');
                return;
            }

            startProcessing();
            try {
                provider = new ethers.BrowserProvider(newProvider);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById('addr').innerText = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('network').innerText = 'Monad Testnet';
                showToast('Wallet connected!', 'success');

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                const chainId = Number((await provider.getNetwork()).chainId);
                if (chainId !== monadTestnet.chainId) {
                    try {
                        await newProvider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: `0x${monadTestnet.chainId.toString(16)}` }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await newProvider.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: `0x${monadTestnet.chainId.toString(16)}`,
                                    chainName: monadTestnet.name,
                                    nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
                                    rpcUrls: [monadTestnet.rpcUrl],
                                    blockExplorerUrls: [monadTestnet.explorerUrl],
                                }],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }

                await refreshOwnedSnakes();
            } catch (err) {
                showToast(`Connection failed: ${err.message || 'Unknown error'}`, 'error');
            } finally {
                stopProcessing();
            }
        });

        document.getElementById('connectBtn').addEventListener('click', () => {
            startProcessing();
            modal.open();
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            modal.disconnect();
        });

        // --- Contract Interactions ---
        async function safeTx(fn, successMsg = 'Transaction succeeded!') {
            if (!contract || !userAddress) {
                showToast('Please connect wallet first', 'warning');
                return;
            }
            startProcessing();
            try {
                const tx = await fn();
                await tx.wait();
                showToast(successMsg, 'success');
                await refreshOwnedSnakes();
            } catch (err) {
                showToast(`Transaction failed: ${err.message || 'Unknown error'}`, 'error');
            } finally {
                stopProcessing();
            }
        }

        document.getElementById('mintClassicBtn').addEventListener('click', async () => {
            await safeTx(() => contract.mintClassic(userAddress, { value: ethers.parseEther('0.01') }), 'Classic snake minted!');
        });

        document.getElementById('mintFastBtn').addEventListener('click', async () => {
            await safeTx(() => contract.mintFastSnake(userAddress, { value: ethers.parseEther('1.0') }), 'Fast snake minted!');
        });

        document.getElementById('mintHeartyBtn').addEventListener('click', async () => {
            await safeTx(() => contract.mintHeartySnake(userAddress, { value: ethers.parseEther('1.0') }), 'Hearty snake minted!');
        });

        document.getElementById('mintLongBtn').addEventListener('click', async () => {
            await safeTx(() => contract.mintLongSnake(userAddress, { value: ethers.parseEther('1.0') }), 'Long snake minted!');
        });

        document.getElementById('depositBtn').addEventListener('click', async () => {
            const amount = document.getElementById('depositAmount').value || '0.05';
            await safeTx(() => contract.depositToGame({ value: ethers.parseEther(amount) }), `Deposited ${amount} MON!`);
        });

        async function refreshOwnedSnakes() {
            const sel = document.getElementById('selectOwnedSnakes');
            sel.innerHTML = '<option value="">Loading...</option>';
            if (!contract || !userAddress) {
                sel.innerHTML = '<option value="">Connect wallet</option>';
                return;
            }
            startProcessing();
            try {
                const balance = Number(await contract.balanceOf(userAddress));
                sel.innerHTML = '';
                if (balance === 0) {
                    sel.innerHTML = '<option value="">No snakes owned</option>';
                    return;
                }
                let found = 0;
                for (let t = 0; t < 500 && found < balance; t++) {
                    try {
                        const owner = await contract.ownerOf(t);
                        if (owner.toLowerCase() === userAddress.toLowerCase()) {
                            const opt = document.createElement('option');
                            opt.value = t.toString();
                            opt.innerText = `#${t}`;
                            sel.appendChild(opt);
                            found++;
                        }
                    } catch { }
                }
                if (found === 0) sel.innerHTML = '<option value="">No tokens found</option>';
            } finally {
                stopProcessing();
            }
        }

        // --- Screen Navigation ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        document.getElementById('buy').addEventListener('click', () => showScreen('screenBuy'));
        document.getElementById('deposit').addEventListener('click', () => showScreen('screenDeposit'));
        document.getElementById('help').addEventListener('click', () => showScreen('screenHelp'));
        document.getElementById('buyBack').addEventListener('click', () => showScreen('screenMenu'));
        document.getElementById('depositBack').addEventListener('click', () => showScreen('screenMenu'));
        document.getElementById('helpBack').addEventListener('click', () => showScreen('screenMenu'));

        document.getElementById('leaderboardBtn').addEventListener('click', async () => {
            showScreen('screenLeaderboard');
            const tbody = document.querySelector('#leaderboardTable tbody');
            tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            try {
                const { data } = await supabase.from('leaderboard').select('wallet, score').order('score', { ascending: false }).limit(10);
                tbody.innerHTML = '';
                data.forEach((row, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${i + 1}</td><td>${row.wallet.slice(0, 6)}...${row.wallet.slice(-4)}</td><td>${row.score}</td>`;
                    tbody.appendChild(tr);
                });
            } catch {
                tbody.innerHTML = '<tr><td colspan="3">Error loading leaderboard</td></tr>';
            }
        });

        document.getElementById('leaderboardBack').addEventListener('click', () => showScreen('screenMenu'));

        // --- Game Logic ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const GRID = 20;
        let gridSize;
        let gameState = {
            snake: [{ x: 10, y: 10 }],
            dir: { x: 1, y: 0 },
            food: { x: 15, y: 15 },
            score: 0,
            hearts: 1,
            type: 'classic',
            speed: 150,
            running: false,
            prepaidMode: true,
            tickTimer: null
        };

        function resizeCanvas() {
            const holder = document.getElementById('gameHolder');
            const availableHeight = window.innerHeight - holder.getBoundingClientRect().top - 20;
            canvas.width = canvas.height = Math.min(window.innerWidth - 32, availableHeight);
            gridSize = canvas.width / GRID;
            if (gameState.running) draw();
        }

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(resizeCanvas, 100);
        });

        function openGame() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameHolder').style.display = 'block';
            document.getElementById('hud').style.display = 'flex';
            hideModal();
            resizeCanvas();
            resetAndStartGame();
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                document.getElementById('touch').style.display = 'grid';
            }
        }

        function resetAndStartGame() {
            gameState.snake = [{ x: 10, y: 10 }];
            gameState.dir = { x: 1, y: 0 };
            gameState.food = randomCell();
            gameState.score = 0;
            gameState.hearts = 1;
            gameState.type = 'classic';
            gameState.speed = 150;
            gameState.running = true;
            updateHUD();
            draw();
            scheduleTick();
        }

        function randomCell() {
            return { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#07020b';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc((gameState.food.x + 0.5) * gridSize, (gameState.food.y + 0.5) * gridSize, gridSize / 3, 0, Math.PI * 2);
            ctx.fill();

            for (let i = 0; i < gameState.snake.length; i++) {
                const s = gameState.snake[i];
                const cx = (s.x + 0.5) * gridSize, cy = (s.y + 0.5) * gridSize;
                if (i === 0) {
                    ctx.fillStyle = gameState.type === 'classic' ? '#b388ff' : '#00ffaa';
                    ctx.beginPath();
                    ctx.arc(cx, cy, gridSize / 2.1, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(cx - gridSize / 5, cy - gridSize / 6, gridSize / 10, 0, Math.PI * 2);
                    ctx.arc(cx + gridSize / 5, cy - gridSize / 6, gridSize / 10, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    const t = i / gameState.snake.length;
                    const opacity = 0.6 * (1 - t) + 0.2;
                    const radius = (gridSize / 2.5) * (1 - t * 0.6);
                    ctx.fillStyle = `rgba(179,136,255,${opacity})`;
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function scheduleTick() {
            clearTimeout(gameState.tickTimer);
            gameState.tickTimer = setTimeout(tick, gameState.speed);
        }

        async function tick() {
            if (!gameState.running) return;
            let head = { x: gameState.snake[0].x + gameState.dir.x, y: gameState.snake[0].y + gameState.dir.y };
            head.x = (head.x + GRID) % GRID;
            head.y = (head.y + GRID) % GRID;

            for (let i = 1; i < gameState.snake.length; i++) {
                if (head.x === gameState.snake[i].x && head.y === gameState.snake[i].y) {
                    if (gameState.hearts > 1) {
                        gameState.hearts -= 1;
                        gameState.snake = gameState.snake.slice(0, Math.max(1, Math.floor(gameState.snake.length / 2)));
                        updateHUD();
                        draw();
                        return scheduleTick();
                    } else {
                        return onGameOver();
                    }
                }
            }

            gameState.snake.unshift(head);

            if (head.x === gameState.food.x && head.y === gameState.food.y) {
                gameState.score += 10;
                if (gameState.type === 'hearty') {
                    gameState.snake.push({ ...gameState.snake[gameState.snake.length - 1] });
                    gameState.snake.push({ ...gameState.snake[gameState.snake.length - 1] });
                    gameState.hearts = Math.max(1, gameState.hearts);
                }
                if (gameState.type === 'long') {
                    while (gameState.snake.length < 6) gameState.snake.push({ ...gameState.snake[gameState.snake.length - 1] });
                }
                if (gameState.type === 'fast') {
                    gameState.speed = Math.max(60, gameState.speed - 8);
                }
                gameState.food = randomCell();
                updateHUD();

                if (contract) {
                    if (gameState.prepaidMode) {
                        await safeTx(() => contract.consumeFromBalance(FOOD_FEE), '');
                    } else {
                        await safeTx(() => contract.payForFood({ value: FOOD_FEE }), '');
                    }
                }
            } else {
                gameState.snake.pop();
            }

            updateHUD();
            draw();
            scheduleTick();
        }

        function updateHUD() {
            document.getElementById('score').innerText = gameState.score;
            document.getElementById('lives').innerText = 'üíú'.repeat(gameState.hearts);
            document.getElementById('type').innerText = gameState.type;
        }

        window.addEventListener('keydown', (e) => {
            if (!gameState.running) return;
            if (e.key === 'ArrowUp' && gameState.dir.y !== 1) gameState.dir = { x: 0, y: -1 };
            if (e.key === 'ArrowDown' && gameState.dir.y !== -1) gameState.dir = { x: 0, y: 1 };
            if (e.key === 'ArrowLeft' && gameState.dir.x !== 1) gameState.dir = { x: -1, y: 0 };
            if (e.key === 'ArrowRight' && gameState.dir.x !== -1) gameState.dir = { x: 1, y: 0 };
        });

        document.getElementById('touchLeft').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState.dir.x !== 1) gameState.dir = { x: -1, y: 0 };
        });
        document.getElementById('touchRight').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState.dir.x !== -1) gameState.dir = { x: 1, y: 0 };
        });
        document.getElementById('touchUp').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState.dir.y !== 1) gameState.dir = { x: 0, y: -1 };
        });
        document.getElementById('touchDown').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState.dir.y !== -1) gameState.dir = { x: 0, y: 1 };
        });

        document.getElementById('pause').addEventListener('click', () => {
            gameState.running = !gameState.running;
            document.getElementById('pause').innerText = gameState.running ? 'Pause' : 'Resume';
            if (!gameState.running) {
                showModal('Paused', 'Game paused. Resume or return to menu?', 'Resume', 'Back to Menu', () => {
                    hideModal();
                    gameState.running = true;
                    document.getElementById('pause').innerText = 'Pause';
                    scheduleTick();
                }, () => {
                    hideModal();
                    gameState.running = false;
                    document.getElementById('gameHolder').style.display = 'none';
                    document.getElementById('hud').style.display = 'none';
                    document.getElementById('menu').style.display = 'flex';
                    showScreen('screenMenu');
                });
            }
        });

        function showModal(title, bodyHtml, action1Text, action2Text, action1, action2) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('action1').innerText = action1Text;
            document.getElementById('action2').innerText = action2Text;
            document.getElementById('action1').onclick = action1;
            document.getElementById('action2').onclick = action2;
            document.getElementById('modal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }

        async function onGameOver() {
            if (!gameState.running) return;

            gameState.running = false;
            clearTimeout(gameState.tickTimer);
            document.getElementById('pause').innerText = 'Pause';
            showToast(`Game Over! Final Score: ${gameState.score}`, 'error', 4000);

            if (userAddress) {
                try {
                    await fetch(`${SUPABASE_URL}/functions/v1/submit-score`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
                        body: JSON.stringify({ wallet: userAddress, score: gameState.score })
                    });
                } catch (err) {
                    showToast('Failed to submit score to leaderboard', 'error');
                }
            }

            if (contract) {
                await safeTx(() => contract.submitScore(0, gameState.score));
            }

            document.getElementById('finalScore').innerText = gameState.score;
            showModal(
                'Game Over!',
                `Final Score: <strong>${gameState.score}</strong>. Play again?`,
                'Play Again',
                'Back to Menu',
                () => {
                    hideModal();
                    resetAndStartGame();
                },
                () => {
                    hideModal();
                    document.getElementById('gameHolder').style.display = 'none';
                    document.getElementById('hud').style.display = 'none';
                    document.getElementById('menu').style.display = 'flex';
                    showScreen('screenMenu');
                }
            );
        }

        document.getElementById('newGame').addEventListener('click', async () => {
            if (!contract || !userAddress) {
                showToast('Please connect wallet first', 'warning');
                return;
            }
            startProcessing();
            try {
                const balance = await contract.balanceOf(userAddress);
                if (balance == 0) {
                    showToast('You must mint a Classic snake first', 'warning');
                    showScreen('screenBuy');
                    return;
                }
                openGame();
            } catch (err) {
                showToast(`Failed to check ownership: ${err.message || 'Unknown error'}`, 'error');
            } finally {
                stopProcessing();
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            resizeCanvas();
            const connectedWallets = await modal.getConnectedWalletInfo();
            if (connectedWallets && connectedWallets.length > 0) {
                const provider = new ethers.BrowserProvider(window.ethereum);
                modal.subscribeProvider(provider);
            }
        });
    </script>
</body>

</html>
